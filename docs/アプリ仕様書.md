# RecRadiko2 アプリケーション仕様書

## 1. 概要

### 1.1 アプリケーション名
RecRadiko2

### 1.2 目的
Radikoのタイムフリー機能を使用して、過去に放送されたラジオ番組を録音するmacOSアプリケーション

### 1.3 対象プラットフォーム
- macOS 15.5以上

## 2. 主要機能

### 2.1 タイムフリー番組の録音
- Radikoで過去1週間以内に放送された番組を録音
- 録音形式：AAC（.m4aファイル）
- 音質：高音質の可変ビットレート（VBR）
- 録音中の進捗表示（経過時間、ダウンロード進捗）

### 2.2 地域・放送局選択
- 地域を選択して該当地域の放送局一覧を表示
- 放送局を選択して番組一覧へ遷移

### 2.3 番組選択
- 選択した放送局の番組一覧を日付別に表示
- 番組を選択して録音開始

## 3. 画面構成

### 3.1 放送局一覧画面
**機能**
- 地域選択機能（東京・大阪等）
- 選択した地域の放送局一覧表示
- 放送局選択による番組一覧画面への遷移
- Radiko APIから取得した放送局情報の表示

**UI要素**
- 上部タブバー（「ラジオ局を選ぶ」「ラジオ局」「設定」）
- 利用説明セクション
  - radiko.jp専用であることの表示（チェックマーク付き）
  - エリア選択ドロップダウン
  - ラジコプレミアムアカウントに関する説明文
- 放送局グリッド（5列表示）
  - Radiko APIから取得した放送局ロゴ画像
  - 放送局名（APIから取得）
  - ホバー時の拡大エフェクト

**デザイン仕様**
- ダークテーマ（背景色：黒〜ダークグレー）
- 放送局サムネイル：120x80px

### 3.2 番組一覧画面
**機能**
- 放送日選択（過去1週間）
- 選択した日付の番組一覧表示
- 番組選択と詳細表示
- 録音機能
- 深夜番組対応（25時間表記）

**UI要素**
- 上部タブバー（放送局一覧画面と共通）
- 左側パネル（300px幅）
  - 現在放送中の番組情報または選択した番組の詳細
  - 放送局ロゴ
  - 番組名、放送時間、パーソナリティ情報
- 右側パネル
  - 再生・録音ボタン（上部）
  - 日付選択バー
  - 番組リスト
    - ラジオボタン（選択状態表示）
    - 放送時刻（等幅フォント、25時間表記対応）
    - 番組名（Radiko APIから取得）

**深夜番組表示仕様**
- **時刻表示**: 25時間表記（24:00-29:00）
- **日付基準**: 放送開始日で表示（月曜深夜1:00 → 「月曜日 25:00」）
- **日付選択**: 放送開始日で選択（月曜深夜番組 → 月曜日選択）
- **深夜番組範囲**: 24:00～29:00（実際の00:00～05:00）
- **視覚的区別**: なし（通常番組と同じ表示）

**デザイン仕様**
- 2カラムレイアウト
- 選択した番組のハイライト表示

### 3.3 設定画面
**機能**
- 録音ファイルの保存先設定
- ラジコプレミアムアカウント設定

**UI要素**
- 上部タブバー（他画面と共通）
- ファイル保存場所セクション
  - 「変更」ボタン
  - 現在の保存先パス表示
- ラジコプレミアムサービス会員設定セクション
  - メールアドレス入力欄
  - パスワード入力欄
  - 「設定 & 確認」ボタン

**デザイン仕様**
- グレーのボタン（背景色：gray.opacity(0.8)）
- 入力欄の背景色：Color(white: 0.3)

### 3.4 録音進捗ポップアップ
**機能**
- 録音中の進捗表示
- 録音のキャンセル機能
- 録音中は他の操作を無効化
- アプリ最小化・非アクティブ時も録音継続

**UI要素**
- タイトル「録音中...」
- 番組名表示
- プログレスバー（ダウンロード進捗ベース）
- 経過時間表示（MM:SS形式）
- キャンセルボタン（赤色）

**操作制限**
- 録音中はキャンセル以外の操作を禁止
- 他画面への移動を無効化
- 番組選択・設定変更を禁止

**録音完了・エラー処理**
- 完了時：ポップアップで完了メッセージ表示
- エラー時：不完全ファイル（.tmp）を自動削除し、エラーメッセージ表示
- アプリ終了時：録音中の場合は確認ダイアログ表示後、録音キャンセル

**デザイン仕様**
- ポップアップサイズ：400x250px
- 背景色：Color(white: 0.2)
- 角丸：12px

## 4. ユーザーフロー

```
1. アプリ起動
   ↓
2. 放送局一覧画面
   ├→ 地域を選択
   ├→ 放送局一覧が表示される
   └→ 放送局を選択
   ↓
3. 番組一覧画面
   ├→ 放送日を選択
   ├→ 番組一覧が表示される
   └→ 番組を選択
   ↓
4. 録音確認ダイアログ（オプション）
   └→ 録音開始を確認
   ↓
5. 録音進捗ポップアップ
   ├→ 録音中（プログレスバー更新）
   └→ 録音完了/キャンセル
```

## 5. 技術要件

### 5.1 開発環境
- プラットフォーム：macOS 15.5以上
- 開発言語：Swift 5.0
- UIフレームワーク：SwiftUI
- IDE：Xcode 16.4

### 5.2 Radiko API連携
- タイムフリー対応のAPI使用
- 認証処理（ラジコプレミアムアカウント対応）
- 深夜番組の日付・時刻処理対応
- APIから取得するデータ：
  - 放送局情報（ID、名称、ロゴ画像URL）
  - 番組情報（番組名、放送時間、パーソナリティ）
  - 音声ストリームURL

### 5.3 録音機能
- ストリーミング音声の録音
- 録音ファイルの保存管理
- バックグラウンド処理対応
- 録音形式：AAC（.m4aファイル）
- スリープ防止機能（録音中）
- 一時ファイル管理（.tmp拡張子使用）

### 5.4 データ管理
- 録音ファイルの保存（ユーザー指定のディレクトリ）
- ファイル管理方式：フラット構造（階層なし）
- ファイル命名規則：`<放送日YYYYMMDD>_<放送局名>_<番組名>.m4a`
- 重複ファイル処理：自動連番追加（`_001`, `_002`等）
- 設定情報の永続化（AppStorage使用）
  - 保存先ディレクトリパス
  - ラジコプレミアムアカウント情報（将来実装予定・現在保留）

### 5.5 UI/UX要件
- ダークテーマのデザイン
- 最小ウィンドウサイズ：800x600px（放送局一覧）、900x700px（番組一覧）
- アニメーション：ホバーエフェクト、画面遷移
- NavigationViewによる画面遷移管理

## 6. 録音機能の詳細仕様

### 6.1 録音形式・品質
- **音声コーデック**: AAC
- **ファイル拡張子**: .m4a
- **音質**: 高音質の可変ビットレート（VBR）
- **実際の録音**: 可変ビットレート（VBR）を使用
- **容量計算基準**: 320kbps（固定値で計算）
- **サンプリングレート**: Radikoの配信品質に準拠

### 6.2 ファイル命名・管理
- **命名規則**: `<放送日YYYYMMDD>_<放送局名>_<番組名>.m4a`
- **放送日**: 放送開始日基準（深夜番組は前日扱い）
- **文字処理**: 特殊文字（`/` `\` `:` `*` `?` `"` `<` `>` `|` ` `）をアンダーバーに置換
- **重複処理**: 自動連番追加（`_001`, `_002`, `_003`...）
- **保存構造**: フラット構造（階層なし）

### 6.3 録音中の動作
- **基本操作**: キャンセルのみ（一時停止・再開なし）
- **進捗表示**: 経過時間（MM:SS）、ダウンロード進捗バー
- **操作制限**: 録音中は他のUI操作を無効化
- **継続条件**: アプリ最小化・非アクティブ時も継続
- **スリープ防止**: macOSスリープを抑制

### 6.4 エラー処理・完了処理
- **一時ファイル**: 録音中は`.tmp`拡張子で保存
- **正常完了**: `.tmp` → `.m4a`にリネーム、完了メッセージ表示
- **エラー発生**: `.tmp`ファイル自動削除、エラーメッセージ表示
- **アプリ終了**: 録音中の場合は確認ダイアログ→キャンセル→削除

### 6.5 ネットワークエラー処理
- **番組表取得失敗**: エラーメッセージ表示（キャッシュ使用なし）
- **録音中のネットワーク切断**: 即座に録音中断、エラーメッセージ表示
- **不完全ファイル処理**: `.tmp`ファイルを自動削除
- **エラーメッセージ**:
  - 「ネットワークエラー：番組表を取得できませんでした」
  - 「録音エラー：ネットワーク接続が切断されました」

### 6.6 ディスク容量管理
- **事前容量チェック**: 6時間の録音分の空き容量を確認（約864MB）
- **容量計算**: 320kbps × 6時間 = 約864MB
- **ファイルサイズ想定**: 1時間番組 = 約144MB（320kbps基準）
- **容量不足時**: 録音開始時にエラーメッセージ表示、録音開始を禁止
- **チェックタイミング**: 録音開始ボタン押下時
- **エラーメッセージ**: 「容量不足：録音に必要な空き容量が不足しています（6時間分の容量が必要）」

### 6.7 深夜番組の処理
- **時刻変換**: APIの実際時刻 ↔ 25時間表記の相互変換
- **日付処理**: 放送開始日基準での日付管理
- **境界時刻**: 05:00で日付境界を設定
- **内部処理**: API送信時は実際の日時に変換
- **表示処理**: 受信データを25時間表記に変換
- **ファイル名**: 放送開始日（前日）で命名

### 6.8 初回起動時の設定
- **保存先フォルダ初期値**: デスクトップ（`~/Desktop`）
- **地域初期値**: 東京（JP13）
- **画面遷移**: 直接放送局一覧画面へ遷移
- **設定画面誘導**: なし
- **設定保存**: AppStorageに即座に保存
- **初回判定**: `isFirstLaunch`フラグで管理

### 6.9 利用規約・ドキュメント
- **配置**: アプリに同梱
- **アクセス**: 設定画面からアクセス可能
- **内容**:
  - Radikoの利用規約への言及
  - 個人利用限定の注意
  - 著作権に関する注意
- **初回強制表示**: なし

### 6.10 アプリケーションの状態管理
- **記憶する状態**: 地域設定のみ（前回選択した地域ID）
- **記憶しない項目**:
  - 前回選択した放送局
  - 前回選択した日付・番組
  - ウィンドウサイズ・位置
- **起動時の動作**:
  - 常に放送局一覧画面に遷移
  - 前回選択した地域を初期選択状態で表示
  - 日付は常に今日を初期選択
- **保存方法**: AppStorageで地域設定のみ管理
- **保存タイミング**: 地域選択変更時に即座保存

### 6.11 番組表データの管理
- **キャッシュ更新方式**:
  - 更新頻度：6時間ごとに自動更新
  - 強制更新：アプリ起動時は必ず更新実行
  - 更新判定：前回更新から6時間経過をチェック
- **データ保持期間**:
  - 保持日数：過去1週間分（Radikoのタイムフリー制限に合わせる）
  - 対象期間：今日を含む過去7日間の番組表データ
  - 古いデータ：1週間を超えたデータは自動削除
- **キャッシュ保存**:
  - 保存場所：AppStorage
  - 保存形式：JSON形式でシリアライズ
  - 保存項目：番組表データ、最終更新時刻、地域ID
- **更新タイミング**:
  - アプリ起動時：必ず更新を実行
  - 6時間経過時：バックグラウンドで自動更新
  - 地域変更時：新しい地域のデータを取得
  - 日付選択時：該当日のデータ存在確認（6時間ルール適用）
- **エラー処理**:
  - ネットワークエラー発生時：キャッシュを完全消去
  - 表示：常にエラーメッセージ表示（キャッシュ使用なし）
  - リトライ：ユーザーの手動操作でのみ再試行

### 6.12 録音品質・容量の詳細
- **実際の録音**: 可変ビットレート（VBR）を使用
- **容量計算基準**: 320kbps（固定値で容量チェック用）
- **ファイルサイズ計算**:
  - 1時間番組：約144MB（320kbps × 3600秒 ÷ 8）
  - 6時間分：約864MB（容量チェック基準）
- **録音時間制限**: なし（番組の長さに依存）
- **容量チェック**: 録音開始時に864MB以上の空き容量を確認
- **実装考慮点**:
  - 実際の録音はVBRのためファイルサイズは変動
  - 容量計算は320kbps固定値で安全側に見積もり
  - 一時ファイル（.tmp）分の追加容量も考慮

## 7. 非機能要件

### 7.1 パフォーマンス
- スムーズなUI操作
- 安定した録音処理
- 効率的なメモリ使用

### 7.2 ユーザビリティ
- 直感的な操作性
- わかりやすいUI
- エラー時の適切なフィードバック

### 7.3 セキュリティ
- APIキーの安全な管理
- ユーザーデータの保護

## 8. 制約事項

### 8.1 Radikoサービスの制約
- タイムフリーは過去1週間分のみ
- 地域制限あり（開発対象：神奈川県 JP14）
- 一部番組は録音不可の可能性
- プレミアム認証機能は将来実装予定（現在保留）

### 8.2 技術的制約
- macOS 15.5以上が必要
- インターネット接続必須

### 8.3 録音機能の制約
- 録音形式：AAC（.m4a）のみ対応
- ビットレート：可変ビットレート（VBR）
- 容量計算：320kbps固定値で計算
- 同時録音：1番組のみ
- 録音中の操作制限：キャンセルのみ可能
- ファイル名文字制限：特殊文字はアンダーバーに自動変換
- 最大録音時間：制限なし（番組の長さに依存）

### 8.4 深夜番組の制約
- 表示形式：25時間表記（24:00-29:00）固定
- 日付基準：放送開始日基準（変更不可）
- 境界時刻：05:00固定（設定変更不可）
- 視覚的区別：深夜番組の特別表示なし

## 9. 今後の拡張可能性

- **プレミアム認証機能**: ラジコプレミアムアカウントでのエリアフリー対応
- **リアルタイム録音機能**: 現在放送中の番組の録音
- **録音スケジュール機能**: 指定時刻での自動録音
- **番組検索機能**: 番組名・出演者での検索
- **録音履歴管理**: 過去の録音結果の一覧表示
- **再生機能の内蔵**: アプリ内での録音ファイル再生
- **複数番組同時録音**: 複数の番組を並行録音
- **音質設定の拡張**: 複数の品質レベル選択