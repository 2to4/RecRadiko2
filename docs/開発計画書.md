# RecRadiko2 開発計画書

**策定日**: 2025年7月24日  
**プロジェクト**: RecRadiko2 (macOS SwiftUI アプリケーション)  
**開発手法**: テスト駆動開発（TDD）- t_wada手法厳格適用

## 1. 仕様分析と開発戦略

### 1.1 要件複雑度分析

#### 高複雑度要件
- **Radiko API連携**: 認証、番組表、ストリーミング取得
- **録音機能**: リアルタイムストリーミング録音、ファイル管理
- **深夜番組処理**: 25時間表記、日付変換ロジック
- **番組一覧画面**: 2カラムレイアウト、状態管理

#### 中複雑度要件
- **放送局一覧画面**: グリッドレイアウト、ホバーエフェクト
- **設定画面**: フォーム処理、ファイル選択
- **データ管理**: AppStorage、キャッシュ管理

#### 低複雑度要件
- **基本ナビゲーション**: タブバー、画面遷移
- **共通UIコンポーネント**: ボタン、入力欄
- **初回起動処理**: 初期値設定

### 1.2 技術リスク評価

#### 高リスク
1. **Radiko API仕様変更**: 外部依存、非公式API
2. **録音品質・安定性**: ストリーミング処理、ファイルI/O
3. **認証処理**: 複雑な認証フロー、地域制限

#### 中リスク
1. **macOS権限**: ファイルアクセス、ネットワーク
2. **UI応答性**: 大量データ表示、スムーズなアニメーション
3. **メモリ管理**: 長時間録音、大容量ファイル

#### 低リスク
1. **SwiftUI基本機能**: 標準コンポーネント使用
2. **ローカルデータ管理**: AppStorage使用
3. **基本的なユーザビリティ**: 標準的なmacOSアプリ

## 2. 開発フェーズ戦略

### Phase 1: 基盤構築・UI実装 [2週間] 🚧 **進行中 - 60%完了**
**目標**: 動作するUIプロトタイプの完成  
**TDD適用**: UI要素の動作確認テスト  
**開始日**: 2025年7月24日  
**進捗**: 設計完了、基盤実装完了、放送局一覧画面完成

#### 事前作業: 設計・テスト仕様策定 [2日間] ✅ **完了**
1. **概要設計書作成** ✅ **完了 [2025/07/24]**
   - システム全体アーキテクチャ
   - モジュール構成・依存関係
   - データフロー設計
   - 技術選定根拠

2. **詳細設計書作成（Phase 1対象）** ✅ **完了 [2025/07/24]**
   - UI コンポーネント詳細設計
   - View・ViewModel構造設計
   - 状態管理方式詳細
   - ナビゲーション仕組み設計

3. **テスト仕様書作成（Phase 1対象）** ✅ **完了 [2025/07/24]**
   - UIコンポーネントテストケース
   - 画面遷移テストシナリオ
   - 状態管理テスト仕様
   - モックデータ仕様

#### 開発項目 [12日間] 🚧 **進行中**
1. **プロジェクト基盤** ✅ **完了 [2025/07/24]**
   - Xcode設定、依存関係設定
   - アーキテクチャ設計（MVVM）
   - 共通コンポーネント定義

2. **基本画面実装** 🚧 **進行中 (25%完了)**
   - 放送局一覧画面（モックデータ） ✅ **完了 [2025/07/24]**
   - 番組一覧画面（モックデータ） 🚧 **次回実装予定**
   - 設定画面 ⏳ **待機中**
   - 録音進捗ポップアップ ⏳ **待機中**

3. **ナビゲーション** ⏳ **待機中**
   - タブバー実装
   - 画面遷移ロジック
   - 状態管理基盤

### Phase 2: API連携・データ管理 [3週間]
**目標**: Radiko APIとの完全連携
**TDD適用**: API通信、データ変換の詳細テスト

#### 事前作業: 設計・テスト仕様策定 [2日間]
1. **詳細設計書作成（Phase 2対象）**
   - Radiko API通信設計
   - 認証フロー詳細設計
   - データモデル設計
   - キャッシュ機構設計
   - 深夜番組処理アルゴリズム設計

2. **テスト仕様書作成（Phase 2対象）**
   - API通信テストケース（正常・異常系）
   - 認証フローテスト仕様
   - データ変換テスト仕様
   - キャッシュ機能テスト仕様
   - 深夜番組処理テスト仕様
   - モックAPI仕様

#### 開発項目 [19日間]
1. **Radiko認証実装**
   - auth1/auth2フロー
   - 認証状態管理
   - エラーハンドリング

2. **番組表機能**
   - 放送局リスト取得
   - 番組表取得・パース
   - キャッシュ機能（6時間更新）

3. **深夜番組対応**
   - 25時間表記変換
   - 日付処理ロジック
   - UI表示調整

4. **データ永続化**
   - AppStorage実装
   - 設定管理
   - 状態復元機能

### Phase 3: 録音機能実装 [4週間]
**目標**: 完全な録音機能の実現
**TDD適用**: 録音プロセス、ファイル操作の厳密テスト

#### 事前作業: 設計・テスト仕様策定 [2日間]
1. **詳細設計書作成（Phase 3対象）**
   - ストリーミング取得アーキテクチャ設計
   - M3U8解析・セグメント処理設計
   - 録音エンジン設計（AAC/VBR）
   - ファイル管理システム設計
   - 録音UI・状態管理設計
   - エラーハンドリング設計

2. **テスト仕様書作成（Phase 3対象）**
   - ストリーミング取得テスト仕様
   - 録音品質テスト仕様
   - ファイル操作テスト仕様（容量、権限、命名）
   - 録音UI動作テスト仕様
   - 異常系テスト仕様（ネットワーク断、ディスク不足）
   - パフォーマンステスト仕様

#### 開発項目 [26日間]
1. **ストリーミング取得**
   - M3U8解析
   - セグメントダウンロード
   - ネットワーク管理

2. **録音エンジン**
   - AAC録音実装
   - VBR品質設定
   - リアルタイム進捗管理

3. **ファイル管理**
   - 命名規則実装
   - 重複処理
   - 容量チェック

4. **録音UI**
   - 進捗表示
   - キャンセル機能
   - 完了・エラー処理

### Phase 4: 品質向上・完成 [2週間]
**目標**: プロダクション品質の達成
**TDD適用**: 統合テスト、パフォーマンステスト

#### 事前作業: 設計・テスト仕様策定 [1日間]
1. **詳細設計書作成（Phase 4対象）**
   - 統合テスト設計
   - パフォーマンス最適化設計
   - エラーハンドリング強化設計
   - セキュリティ対策設計

2. **テスト仕様書作成（Phase 4対象）**
   - 統合テスト仕様（エンドツーエンド）
   - パフォーマンステスト仕様
   - 負荷テスト仕様
   - ユーザビリティテスト仕様
   - セキュリティテスト仕様
   - 受け入れテスト仕様

#### 開発項目 [13日間]
1. **エラーハンドリング強化**
   - ネットワークエラー対応
   - ファイルI/Oエラー対応
   - UI応答性改善

2. **パフォーマンス最適化**
   - メモリ使用量最適化
   - UI応答性向上
   - バックグラウンド処理改善

3. **最終検証**
   - 全機能統合テスト
   - ユーザビリティテスト
   - セキュリティ検証

## 3. 設計書・テスト仕様書の作成戦略

### 3.1 概要設計書の作成方針

#### 作成タイミング
- **Phase 1開始前**: システム全体の概要設計を完成
- **内容**: アーキテクチャ全体像、技術選定、品質方針

#### 含むべき内容
1. **システムアーキテクチャ**
   - MVVM アーキテクチャの適用方針
   - レイヤー間の責務分担
   - 依存関係の方向性

2. **技術選定**
   - SwiftUI採用根拠
   - Swift Testing採用根拠
   - AppStorage選定理由

3. **品質方針**
   - テストカバレッジ目標（90%以上）
   - パフォーマンス目標
   - セキュリティ方針

### 3.2 詳細設計書の作成方針

#### 作成タイミング
- **各Phase開始前**: 対象機能の詳細設計を完成
- **更新**: 実装中の気づきによる設計変更を随時反映

#### Phase別作成内容

##### Phase 1: UI・基盤設計
- **View構造設計**: 各画面のコンポーネント分割
- **ViewModel設計**: 状態管理、データバインディング
- **Navigation設計**: 画面遷移、タブ管理
- **Theme・Style設計**: 共通デザインシステム

##### Phase 2: API・データ設計
- **API通信設計**: HTTPクライアント、エラー処理
- **データモデル設計**: Radiko APIレスポンス対応
- **認証設計**: トークン管理、セキュリティ
- **キャッシュ設計**: データ永続化、更新戦略

##### Phase 3: 録音機能設計
- **ストリーミング設計**: M3U8解析、セグメント管理
- **録音エンジン設計**: AAC変換、品質管理
- **ファイル管理設計**: 命名、重複処理、容量管理
- **並行処理設計**: バックグラウンド録音、UI更新

##### Phase 4: 品質・統合設計
- **エラーハンドリング設計**: 包括的エラー対応
- **パフォーマンス設計**: メモリ、CPU最適化
- **セキュリティ設計**: データ保護、権限管理

### 3.3 テスト仕様書の作成方針

#### 作成タイミング
- **各Phase開始前**: 対象機能のテスト仕様を完成
- **TDDサイクル**: Red段階でテストケースを詳細化

#### テスト種別・内容

##### ユニットテスト仕様
- **対象**: Model、ViewModel、Utility層
- **内容**: 
  - 正常系テストケース
  - 異常系テストケース（境界値、例外）
  - モック・スタブ仕様

##### 統合テスト仕様  
- **対象**: API通信、ファイル操作、データフロー
- **内容**:
  - サービス間連携テスト
  - 外部システム連携テスト
  - エンドツーエンドシナリオ

##### UIテスト仕様
- **対象**: 画面操作、画面遷移、ユーザーインタラクション
- **内容**:
  - 操作シナリオ
  - 表示確認項目
  - エラー画面検証

#### テストデータ・環境仕様
- **モックデータ**: 各種番組データ、エラーレスポンス
- **テスト環境**: 神奈川県IP、容量制限環境
- **自動化**: CI/CD組み込み方針

### 3.4 ドキュメント管理・更新戦略

#### バージョン管理
- **Git管理**: 設計書もソースコードと同じリポジトリで管理
- **更新履歴**: 変更理由、影響範囲を記録
- **レビュー**: 設計変更時の影響評価

#### 品質保証
- **設計レビュー**: 実装前の設計妥当性確認
- **テスト仕様レビュー**: テストケースの網羅性確認
- **実装との整合性**: 実装完了後の設計書更新確認

## 4. テスト駆動開発戦略

### 4.1 TDDサイクル適用方針

**t_wada手法の厳格適用**:
1. **テストリスト作成**: 各機能の網羅的テストシナリオ作成
2. **Red**: 失敗テストを一つずつ作成・確認
3. **Green**: 最小限の実装でテスト通過
4. **Refactor**: 設計改善、重複排除
5. **Repeat**: 完了まで継続

### 4.2 テスト戦略

#### ユニットテスト（Swift Testing）
- **Model層**: データ変換、ロジック検証
- **ViewModel層**: 状態管理、API連携
- **Utility層**: 時刻変換、ファイル処理

#### 統合テスト（Swift Testing）
- **API連携**: モックサーバーでの通信テスト
- **ファイル操作**: 実際のファイルシステムでのテスト
- **データフロー**: 画面間データ連携テスト

#### UIテスト（XCTest）
- **画面遷移**: ナビゲーション動作確認
- **ユーザーインタラクション**: ボタン、入力欄操作
- **エラー表示**: エラー時の画面状態確認

### 3.3 モック・テストデータ戦略

#### API Mock
- **Radiko認証**: 成功・失敗パターン
- **番組表データ**: 通常・深夜・エラーパターン
- **ストリーミング**: ダミーデータ生成

#### ファイルシステムMock
- **容量不足**: ディスク容量制限シミュレーション
- **権限エラー**: アクセス権限制限テスト
- **ファイル破損**: 異常系テスト

## 4. 実装アーキテクチャ

### 4.1 プロジェクト構成
```
RecRadiko2/
├── Models/
│   ├── RadioStation.swift
│   ├── RadioProgram.swift
│   ├── AuthInfo.swift
│   └── RecordingSession.swift
├── ViewModels/
│   ├── StationListViewModel.swift
│   ├── ProgramListViewModel.swift
│   ├── SettingsViewModel.swift
│   └── RecordingViewModel.swift
├── Views/
│   ├── StationListView.swift
│   ├── ProgramListView.swift
│   ├── SettingsView.swift
│   └── RecordingProgressView.swift
├── Services/
│   ├── RadikoAPIService.swift
│   ├── RecordingService.swift
│   ├── CacheService.swift
│   └── FileManagerService.swift
├── Utilities/
│   ├── TimeConverter.swift
│   ├── FileNameSanitizer.swift
│   └── NetworkMonitor.swift
└── Tests/
    ├── UnitTests/
    ├── IntegrationTests/
    └── UITests/
```

### 4.2 依存関係管理
- **外部ライブラリ**: 最小限に抑制
- **Swift標準ライブラリ**: 最大活用
- **macOS Framework**: 必要最小限の使用

### 4.3 データフロー設計
```
User Input → View → ViewModel → Service → Model
                ↓        ↓        ↓        ↓
            UI Update ← State ← Response ← Data
```

## 5. 開発スケジュール

### 5.1 全体スケジュール [11週間]
```
Week 1-2:  Phase 1 - 基盤構築・UI実装
Week 3-5:  Phase 2 - API連携・データ管理
Week 6-9:  Phase 3 - 録音機能実装
Week 10-11: Phase 4 - 品質向上・完成
```

### 5.2 マイルストーン
- **Week 2**: UIプロトタイプ完成
- **Week 5**: API連携完成
- **Week 9**: 録音機能完成
- **Week 11**: プロダクション完成

### 5.3 デイリー開発サイクル
1. **朝**: 前日のテスト実行・問題確認
2. **午前**: TDDサイクル実行（Red→Green→Refactor）
3. **午後**: 継続実装・統合テスト
4. **夕方**: コードレビュー・リファクタリング

## 6. 品質保証戦略

### 6.1 コード品質
- **テストカバレッジ**: 90%以上維持
- **静的解析**: SwiftLint導入検討
- **コードレビュー**: セルフレビューの徹底

### 6.2 機能品質
- **実機テスト**: 神奈川県環境での動作確認
- **エラー処理**: 全エラーケースの検証
- **パフォーマンス**: メモリ・CPU使用量監視

### 6.3 ユーザビリティ
- **レスポンス時間**: 各操作3秒以内
- **エラーメッセージ**: 分かりやすい日本語表示
- **アクセシビリティ**: VoiceOver対応

## 7. リスク管理・対策

### 7.1 技術リスク対策
1. **Radiko API変更**
   - 早期PoC実施
   - API監視・変更追跡
   - 代替手段の検討

2. **録音品質問題**
   - 段階的品質向上
   - ユーザーフィードバック収集
   - A/Bテスト実施

3. **パフォーマンス問題**
   - 継続的なプロファイリング
   - メモリリーク検出
   - ストレステスト実施

### 7.2 スケジュールリスク対策
1. **バッファ時間**: 各フェーズに20%のバッファ
2. **優先順位**: 必須機能の優先実装
3. **段階リリース**: MVP→機能拡張の段階的進行

### 7.3 品質リスク対策
1. **自動テスト**: CI/CD環境構築
2. **継続的監視**: アプリ使用量・エラー監視
3. **ユーザーサポート**: 問い合わせ窓口準備

## 8. 成功指標・KPI

### 8.1 開発指標
- **テストカバレッジ**: 90%以上
- **バグ密度**: 1バグ/1000行以下
- **ビルド成功率**: 95%以上

### 8.2 機能指標
- **録音成功率**: 95%以上
- **API通信成功率**: 98%以上
- **UI応答時間**: 平均1秒以下

### 8.3 品質指標
- **クラッシュ率**: 0.1%以下
- **メモリ使用量**: 平均100MB以下
- **CPU使用率**: 録音時50%以下

## 9. 開発環境・ツール

### 9.1 開発環境
- **macOS**: 15.5以上
- **Xcode**: 16.4
- **Swift**: 5.0
- **Git**: バージョン管理

### 9.2 テストツール
- **Swift Testing**: ユニット・統合テスト
- **XCTest**: UIテスト
- **Instruments**: パフォーマンス分析

### 9.3 品質管理ツール
- **SwiftLint**: コード品質（検討）
- **SonarQube**: 静的解析（検討）
- **TestFlight**: ベータテスト配信

## 10. 継続的改善・保守計画

### 10.1 リリース後の監視
- **使用状況分析**: ユーザー行動追跡
- **エラー監視**: クラッシュレポート分析
- **パフォーマンス監視**: レスポンス時間測定

### 10.2 アップデート計画
- **月次アップデート**: バグフィックス・小改善
- **四半期アップデート**: 新機能追加
- **年次アップデート**: 大幅な機能拡張

### 10.3 技術負債管理
- **コードレビュー**: 定期的なリファクタリング
- **依存関係更新**: ライブラリ・OS対応
- **セキュリティ更新**: 脆弱性対応

---

## まとめ

本開発計画は、t_wadaのテスト駆動開発手法を厳格に適用し、11週間でRecRadiko2を完成させる包括的な戦略です。段階的な実装、継続的なテスト、リスク管理を通じて、高品質なmacOSアプリケーションの開発を目指します。

**重要**: 本計画は開発進行に応じて柔軟に調整し、品質を最優先に進めることが成功の鍵となります。