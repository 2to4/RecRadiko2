# Phase 3テスト仕様書

## 概要

Phase 3「録音機能実装」のテスト仕様書です。t_wadaのテスト駆動開発手法に従い、実装前にテストシナリオを定義し、Red-Green-Refactorサイクルで開発を進めます。

## テスト実装方針

### 基本原則
- **実環境優先**: 実際のファイル・設定・暗号化処理を使用
- **統合テスト重視**: 包括的統合テストによる品質保証
- **モック使用制限**: 外部API・システム操作・UI入力のみ（10%以下）
- **TDD厳守**: テストリスト→Red→Green→Refactor→繰り返し

### テストカテゴリ
1. **ユニットテスト** (Swift Testing): 個別コンポーネントの機能検証
2. **統合テスト** (Swift Testing): コンポーネント間連携の検証
3. **UIテスト** (XCTest): ユーザーインタラクションの検証

## Phase 3 メインテストリスト

### 1. RadikoAPIService統合実装

#### 1.1 番組表取得機能
- [ ] 番組表XML取得の成功パターン
- [ ] 番組表XMLパース処理の正常系
- [ ] 番組表XMLパース処理の異常系（不正フォーマット）
- [ ] 25時間表記の時刻変換処理
- [ ] 番組情報の日付境界処理（深夜番組対応）
- [ ] ネットワークエラー時のリトライ処理
- [ ] タイムアウト処理
- [ ] 複数エリア対応

#### 1.2 認証機能統合
- [ ] auth1/auth2トークン取得の成功
- [ ] トークン有効期限チェック
- [ ] トークン自動更新処理
- [ ] 認証失敗時のエラーハンドリング
- [ ] 認証情報のセキュア保存

### 2. StreamingService実装

#### 2.1 M3U8ストリーミング処理
- [ ] M3U8プレイリスト取得の成功
- [ ] セグメントURL抽出処理
- [ ] セグメントの順次ダウンロード
- [ ] セグメント結合処理
- [ ] ストリーミング中断・再開処理
- [ ] 並行ダウンロード処理（最大3セグメント）
- [ ] ダウンロードエラー時のリトライ
- [ ] 帯域幅制限対応

#### 2.2 音声データ処理
- [ ] AAC音声データの検証
- [ ] 音声品質の確認（サンプリングレート、ビットレート）
- [ ] 音声データの整合性チェック
- [ ] 破損セグメントの検出・スキップ

### 3. RecordingEngine実装

#### 3.1 録音セッション管理
- [ ] 録音セッション開始の成功
- [ ] 録音セッション停止の成功
- [ ] 録音中の状態管理
- [ ] 複数番組の同時録音対応
- [ ] 録音進捗の正確な追跡
- [ ] メモリ使用量の最適化

#### 3.2 录音データ処理
- [ ] ストリーミングデータのリアルタイム保存
- [ ] ファイルフォーマット変換（AAC → M4A）
- [ ] メタデータ埋め込み（番組名、放送日時等）
- [ ] ファイルサイズ制限チェック
- [ ] ディスク容量不足時の処理

#### 3.3 Actor並行処理
- [ ] RecordingActorの状態管理
- [ ] 並行録音セッション間の分離
- [ ] リソース競合の回避
- [ ] デッドロック防止
- [ ] メッセージパッシングの信頼性

### 4. FileManagerService実装

#### 4.1 ファイル操作
- [ ] 録音ファイルの作成・保存
- [ ] ファイル名生成ルール（番組名_日時.m4a）
- [ ] ディレクトリ構造の自動作成
- [ ] ファイル移動・コピー処理
- [ ] ファイル削除処理
- [ ] ファイル権限設定

#### 4.2 ストレージ管理
- [ ] 利用可能容量の監視
- [ ] 容量不足時のアラート
- [ ] 古いファイルの自動削除
- [ ] 録音品質別の容量計算
- [ ] 外部ストレージ対応

### 5. RecordingScheduler実装

#### 5.1 スケジュール管理
- [ ] 録音スケジュールの登録
- [ ] スケジュールの編集・削除
- [ ] 重複スケジュールの検出
- [ ] スケジュール実行の精度（±5秒）
- [ ] 長時間番組の分割録音対応

#### 5.2 バックグラウンド処理
- [ ] アプリ非アクティブ時の録音継続
- [ ] システムスリープ防止
- [ ] 電源管理との連携
- [ ] バックグラウンド実行権限管理
- [ ] 録音完了通知

### 6. UI/ViewModel実装

#### 6.1 録音制御UI
- [ ] 録音開始ボタンの動作
- [ ] 録音停止ボタンの動作
- [ ] 録音状態の視覚表示
- [ ] 録音進捗バーの更新
- [ ] エラー状態の表示

#### 6.2 番組選択UI
- [ ] 番組リストの表示
- [ ] 番組検索機能
- [ ] お気に入り番組の管理
- [ ] 録音予約の設定
- [ ] スケジュール一覧表示

#### 6.3 ファイル管理UI
- [ ] 録音済みファイル一覧
- [ ] ファイル再生機能
- [ ] ファイル削除機能
- [ ] ファイル詳細情報表示
- [ ] エクスポート機能

### 7. エラーハンドリング・回復処理

#### 7.1 ネットワークエラー
- [ ] 接続タイムアウト処理
- [ ] 接続断絶時の自動復旧
- [ ] API応答エラーの分類・処理
- [ ] レート制限対応
- [ ] DNS解決エラー処理

#### 7.2 システムエラー
- [ ] メモリ不足時の処理
- [ ] ディスク容量不足時の処理
- [ ] 権限エラー時の処理
- [ ] ファイルアクセスエラー処理
- [ ] システム再起動時の状態復旧

#### 7.3 録音エラー
- [ ] ストリーミング中断時の処理
- [ ] 音声データ破損時の処理
- [ ] 録音時間超過時の処理
- [ ] 同時録音上限時の処理
- [ ] 録音失敗時のリトライ

### 8. パフォーマンス・最適化

#### 8.1 メモリ最適化
- [ ] ストリーミングバッファ管理
- [ ] 大容量ファイル処理時のメモリ使用量
- [ ] UI更新頻度の最適化
- [ ] オブジェクトライフサイクル管理
- [ ] メモリリーク検出

#### 8.2 処理速度最適化
- [ ] 並行ダウンロードの効率性
- [ ] ファイル書き込み速度
- [ ] UI応答性の維持
- [ ] バックグラウンド処理の優先度
- [ ] CPU使用率の監視

### 9. セキュリティ・権限

#### 9.1 データ保護
- [ ] 認証情報の暗号化保存
- [ ] ファイルアクセス権限の適切な設定
- [ ] 録音データの改ざん検出
- [ ] 一時ファイルの安全な削除
- [ ] プライバシー設定の尊重

#### 9.2 システム権限
- [ ] マイクアクセス権限（録音用）
- [ ] ファイルシステムアクセス権限
- [ ] ネットワークアクセス権限
- [ ] バックグラウンド実行権限
- [ ] 通知権限

### 10. 統合テスト

#### 10.1 エンドツーエンドテスト
- [ ] 番組表取得→番組選択→録音開始→録音完了の全工程
- [ ] 複数番組の同時録音
- [ ] 長時間録音（3時間以上）
- [ ] 録音スケジュール実行
- [ ] エラー発生からの回復

#### 10.2 実環境テスト
- [ ] 実際のRadiko APIとの連携
- [ ] 実ネットワーク環境での動作
- [ ] 様々な番組での録音品質
- [ ] システム負荷時の動作
- [ ] 長期運用時の安定性

## テスト実装順序

### Phase 3.1: 基盤コンポーネント（1週目）
1. RadikoAPIService統合実装テスト
2. StreamingService基本機能テスト
3. FileManagerService基本機能テスト

### Phase 3.2: 録音エンジン（2週目）
1. RecordingEngine基本機能テスト
2. Actor並行処理テスト
3. エラーハンドリングテスト

### Phase 3.3: UI・スケジューラー（3週目）
1. UI/ViewModel機能テスト
2. RecordingScheduler機能テスト
3. バックグラウンド処理テスト

### Phase 3.4: 統合・最適化（4週目）
1. エンドツーエンドテスト
2. パフォーマンステスト
3. セキュリティテスト
4. 実環境テスト

## 成功基準

### 必須機能
- [ ] 全ユニットテスト成功率: 100%
- [ ] 全統合テスト成功率: 100%
- [ ] 録音成功率: 95%以上
- [ ] UI応答時間: 2秒以内
- [ ] メモリ使用量: 100MB以下

### 品質基準
- [ ] 音声品質: オリジナルと同等
- [ ] 録音精度: ±5秒以内
- [ ] 連続動作時間: 24時間以上
- [ ] 同時録音数: 最大5番組
- [ ] エラー回復時間: 30秒以内

## TDD実装手順

各機能について以下の手順で実装：

1. **テストリスト選択**: 上記リストから1つのテストケースを選択
2. **Red**: 失敗するテストコードを書く
3. **Green**: テストを成功させる最小限のコード実装
4. **Refactor**: コード品質を改善
5. **繰り返し**: 次のテストケースへ

## 注意事項

- すべてのテストは実環境での動作を前提とする
- モックは外部API呼び出しとUI入力のみに制限
- テスト失敗時は実装コードを使用しない
- 各フェーズ完了時に全テストの成功を確認
- 日本語コミットメッセージでのバージョン管理

---

**この仕様書に基づき、Phase 3の実装をTDD手法で進めていきます。**